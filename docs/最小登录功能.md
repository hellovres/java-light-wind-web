# 最小登录系统设计文档

## 1. 项目概述

使用 Spring MVC + Thymeleaf + 内存存储实现最小化登录功能。

### 技术栈
- Spring Boot 3.2.0 + Spring MVC
- Spring Security 6.x
- Thymeleaf 3
- 内存存储 (ConcurrentHashMap)
- Java 17

---

## 2. 功能清单

| 功能 | 说明 |
|------|------|
| 用户注册 | 内存创建用户（重启丢失） |
| 用户登录 | 用户名密码验证 |
| 会话管理 | Spring Security Session |
| 退出登录 | 清除Session |

---

## 3. 用户存储

```java
@Service
public class UserService {
    private final Map<String, User> users = new ConcurrentHashMap<>();
    
    @PostConstruct
    public void init() {
        // 演示用户: admin / admin123
        users.put("admin", new User("admin", 
            "$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi", 
            "admin@example.com"));
    }
    
    public void register(String username, String password, String email) {
        users.put(username, new User(username, passwordEncoder.encode(password), email));
    }
    
    public User findByUsername(String username) {
        return users.get(username);
    }
}

@Data
@AllArgsConstructor
public class User {
    private String username;
    private String password;  // BCrypt加密
    private String email;
}
```

---

## 4. Security 配置

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/register", "/css/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .defaultSuccessUrl("/home", true)
                .failureUrl("/login?error=true")
                .permitAll()
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/login?logout=true")
                .permitAll()
            )
            .csrf(csrf -> csrf.disable());
        
        return http.build();
    }
    
    @Bean
    public UserDetailsService userDetailsService(UserService userService) {
        return username -> {
            User user = userService.findByUsername(username);
            return org.springframework.security.core.userdetails.User
                .withUsername(user.getUsername())
                .password(user.getPassword())
                .roles("USER")
                .build();
        };
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

---

## 5. 控制器

```java
@Controller
public class AuthController {
    
    @GetMapping("/login")
    public String login(Model model, String error, String logout, String registered) {
        if (error != null) model.addAttribute("error", "用户名或密码错误");
        if (logout != null) model.addAttribute("message", "已成功退出");
        if (registered != null) model.addAttribute("message", "注册成功，请登录");
        return "login";
    }
    
    @GetMapping("/register")
    public String register() {
        return "register";
    }
    
    @PostMapping("/register")
    public String registerPost(String username, String password, String email, Model model) {
        userService.register(username, password, email);
        return "redirect:/login?registered=true";
    }
}

@Controller
public class HomeController {
    @GetMapping("/home")
    public String home(Model model, Authentication auth) {
        model.addAttribute("username", auth.getName());
        return "home";
    }
}
```

---

## 6. 页面模板

### login.html
```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>登录</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container">
        <h2>用户登录</h2>
        <div th:if="${error}" class="alert error" th:text="${error}"></div>
        <div th:if="${message}" class="alert success" th:text="${message}"></div>
        
        <form th:action="@{/login}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="text" name="username" placeholder="用户名" required>
            <input type="password" name="password" placeholder="密码" required>
            <button type="submit">登录</button>
        </form>
        <p><a th:href="@{/register}">立即注册</a></p>
        <p><small>演示: admin / admin123</small></p>
    </div>
</body>
</html>
```

### register.html
```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>注册</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container">
        <h2>用户注册</h2>
        <form th:action="@{/register}" method="post">
            <input type="text" name="username" placeholder="用户名 (至少3位)" required minlength="3">
            <input type="password" name="password" placeholder="密码 (至少6位)" required minlength="6">
            <input type="email" name="email" placeholder="邮箱 (可选)">
            <button type="submit">注册</button>
        </form>
        <p><a th:href="@{/login}">已有账号？立即登录</a></p>
    </div>
</body>
</html>
```

### home.html
```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>首页</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container">
        <h1>欢迎，<span th:text="${username}">用户</span>！</h1>
        <p><small>注意：用户数据存储在内存中，重启服务后会重置。</small></p>
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn-logout">退出登录</button>
        </form>
    </div>
</body>
</html>
```

### style.css
```css
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, sans-serif; background: #f5f5f5; 
       display: flex; justify-content: center; align-items: center; min-height: 100vh; }
.container { background: white; padding: 2rem; border-radius: 8px; 
             box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
h2, h1 { margin-bottom: 1.5rem; color: #333; text-align: center; }
input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; 
        border-radius: 4px; margin-bottom: 1rem; }
button { width: 100%; padding: 0.75rem; background: #007bff; 
         color: white; border: none; border-radius: 4px; cursor: pointer; }
button:hover { background: #0056b3; }
.btn-logout { background: #dc3545; }
.btn-logout:hover { background: #c82333; }
.alert { padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; }
.alert.error { background: #f8d7da; color: #721c24; }
.alert.success { background: #d4edda; color: #155724; }
p { margin-top: 1rem; text-align: center; color: #666; }
a { color: #007bff; }
```

---

## 7. 配置 (application.yml)

```yaml
spring:
  application:
    name: java-light-wind-web
  thymeleaf:
    prefix: classpath:templates/
    suffix: .html
    mode: HTML
    cache: false
server:
  port: 8080
logging:
  level:
    com.lightwind: DEBUG
    org.springframework.security: DEBUG
```

---

## 8. 目录结构

```
src/main/java/com/lightwind/
├── LightWindApplication.java
├── config/SecurityConfig.java
├── controller/
│   ├── AuthController.java
│   └── HomeController.java
├── service/UserService.java
└── entity/User.java

src/main/resources/
├── application.yml
├── static/css/style.css
└── templates/
    ├── login.html
    ├── register.html
    └── home.html
```

---

## 9. 演示账号

| 用户名 | 密码 |
|--------|------|
| admin | admin123 |

---

## 10. 启动命令

```bash
mvn spring-boot:run
# 访问 http://localhost:8080/login
```

---

*创建日期: 2026-02-08*
